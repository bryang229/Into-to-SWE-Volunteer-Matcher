<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings</title>
    <link rel="stylesheet" href="/css/account_settings.css">
</head>
<body>
    <div class="container">
        <h1>Account Settings</h1>
        <form id="accountSettingsForm">
            <div class="form-group">
                <label for="displayName">Update Display Name</label>
                <input type="text" id="displayName" name="displayName" class="form-control" placeholder="Enter your new display name">
                <small class="form-text text-muted">This will update your username or company name.</small>
            </div>
            <div class="form-group">
                <label for="email">Update Email Address</label>
                <input type="email" id="email" name="email" class="form-control" placeholder="Enter your new email address">
                <small class="form-text text-muted">This will update your email address. You may need to verify the new email.</small>
            </div>
            <div class="form-group">
                <h3>Change Password</h3>
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" name="currentPassword" class="form-control">

                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" class="form-control">

                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control">
            </div>
            <hr>
            <div class="button-group">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Cancel</button>
            </div>
        </form>
        <hr>
        <div class="danger-zone">
            <h3>Danger Zone</h3>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">Delete Account</button>
        </div>
    </div>
    <div class="button-group">
    <!-- Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Account</h2>
            <p>Are you sure you want to delete your account? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button onclick="deleteAccount()" class="btn btn-danger">Yes, Delete My Account</button>
                <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    </div>
    <script>
        let isLoadingUserData = false;

        async function loadUserData() {
            if (isLoadingUserData) return;
            isLoadingUserData = true;
            try {
                console.log('Fetching user data...');
                const response = await fetch('/api/user/settings', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Error response from server:', error);
                    throw new Error(error.message || 'Failed to fetch user data');
                }

                const data = await response.json();
                console.log('User data fetched successfully:', data);
                document.getElementById('displayName').value = data.displayName || '';
                document.getElementById('email').value = data.email || '';
            } catch (error) {
                console.error('Error in loadUserData:', error);
                alert('Error loading profile: ' + error.message);
            } finally {
                isLoadingUserData = false;
            }
        }

        document.getElementById('accountSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                const formData = {
                    displayName: document.getElementById('displayName').value,
                    email: document.getElementById('email').value
                };

                // Include password fields if the user is changing their password
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (currentPassword || newPassword || confirmPassword) {
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        throw new Error('All password fields are required to change your password.');
                    }
                    if (newPassword !== confirmPassword) {
                        throw new Error('New passwords do not match.');
                    }

                    formData.newPassword = newPassword;
                }

                const response = await fetch('/api/user/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Update failed');
                }

                // Check if email was updated
                if (formData.email !== '') {
                    alert('Email updated. Please reauthenticate to continue.');
                    window.location.href = '/templates/auth/login.html'; // Redirect to login page
                    return;
                }

                alert('Profile updated successfully!');
                window.location.reload();
            } catch (error) {
                alert('Error updating profile: ' + error.message);
            }
        });

        async function deleteAccount() {
            try {
                const response = await fetch('/api/user/delete', {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Delete failed');
                }

                alert('Account deleted successfully');
                window.location.href = '/'; // Redirect to index.html
            } catch (error) {
                alert('Error deleting account: ' + error.message);
                closeModal();
            }
        }

        function confirmDeleteAccount() {
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadUserData);
    </script>
</body>
</html>
